/**
 * Object:  Html5RTCRecorder
 * Version: master
 * Author:  Edouard Kombo
 * Twitter: @EdouardKombo
 * Github:  https://github.com/edouardkombo
 * Blog:    http://creativcoders.wordpress.com
 * Url:     https://github.com/edouardkombo/Html5RTCRecorder
 * 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 * 
 * Record audio+video in html5 with webRTC, and convert them in single mp4 (or any other format) file with ffmpeg.
 */

var Html5RTCRecorder=function(){};Html5RTCRecorder.prototype={audioContext:"",url:"",fileName:"",mediaStream:"",recordAudio:"",recordVideo:"",videoTagIdHost:"",videoTagId:"",audioTagId:"",width:"",height:"",callback:"",urlToStream:"",callbackType:"",hideWebcamWhileRecording:"",videoExtension:"",phpFile:"",mediaPath:"",deleteSeparatedFiles:true,rtc:"",frameRate:60,quality:10,client:"",init:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.AudioContext=window.AudioContext||window.webkitAudioContext;window.URL=window.URL||window.webkitURL;this.getUserMedia=navigator.getUserMedia;this.audioContext=window.AudioContext;this.url=window.URL;window.onload=this.onload()},onload:function(){navigator.getUserMedia({audio:true,video:true},this.onStream.bind(this),function(e){console.log("No live audio input or video stream: "+e)})},onStream:function(e){this.resetTags();this.mediaStream=e;this.videoTag.src=this.url.createObjectURL(e);this.videoTag.muted=true;this.videoTag.play()},startRecording:function(){this.client="";if(this.hideWebcamWhileRecording){this.showHideStream("hide")}this.recordAudio="";this.recordVideo="";this.recordAudio=this.rtc(this.mediaStream,{onAudioProcessStarted:function(){this.recordVideo.startRecording()}.bind(this)});var e={type:"video",video:{width:this.width,height:this.height},canvas:{width:this.width,height:this.height},frameRate:this.frameRate,quality:this.quality};this.recordVideo=this.rtc(this.mediaStream,e);this.recordAudio.startRecording()},setFileName:function(){this.fileName=Date.now()},stopRecording:function(){this.setFileName();this.recordAudio.stopRecording(function(){this.recordVideo.stopRecording(function(){this.postBlob(this.recordAudio.getBlob(),this.recordVideo.getBlob(),this.fileName)}.bind(this))}.bind(this))},showHideStream:function(e){if(e==="show"){this.videoTag.style.visibility="visible";this.videoTag.style.display="block"}else if(e==="hide"){this.videoTag.style.visibility="hidden";this.videoTag.style.display="none"}},resetTags:function(){this.createTag("video",this.videoTagId);this.createTag("canvas",this.canvasTagId)},createTag:function(e,t){var n=document.getElementById(t);if(n===null){n=document.createElement(e);if(e==="canvas"){n.width=this.width;n.height=this.height;n.id=t;n.style.position="absolute";n.style.visibility="hidden";this.ctx=n.getContext("2d");this.canvasTag=this.ctx.canvas}else if(e==="video"){n.setAttribute("autoplay","true");n.width=this.width;n.height=this.height;n.id=t;if(this.mediaStream!==""){n.src=window.URL.createObjectURL(this.mediaStream)}this.videoTag=n}document.getElementById(this.videoTagIdHost).appendChild(n)}else{if(e==="canvas"){this.canvasTag=n}else{this.videoTag=n}}},postBlob:function(){var e=new FormData;e.append("audio-blob",this.recordAudio.getBlob());e.append("video-blob",this.recordVideo.getBlob());e.append("videoExtension",this.videoExtension);e.append("mediaPath",this.mediaPath);e.append("filename",this.fileName);e.append("deleteBaseFiles",this.deleteSeparatedFiles);e.append("frameRate",this.frameRate);this.client=new XMLHttpRequest;this.client.onreadystatechange=function(){if(this.client.readyState===4&&this.client.status===200){console.log(this.client.response);this.urlToStream=this.mediaPath+this.fileName+"/"+this.fileName+"."+this.videoExtension;this.callbackType="video";var e=window[this.callback];e();this.showHideStream("show")}}.bind(this);this.client.open("post",this.phpFile);this.client.setRequestHeader("X-Requested-With","XMLHttpRequest");this.client.setRequestHeader("cache-Control","no-store, no-cache, must-revalidate");this.client.setRequestHeader("cache-Control","post-check=0, pre-check=0");this.client.setRequestHeader("cache-Control","max-age=0");this.client.setRequestHeader("Pragma","no-cache");this.client.send(e)}}